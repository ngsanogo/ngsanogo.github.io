services:
  dev:
    container_name: dev
    build:
      context: .
      target: hugo
    command: hugo server --bind 0.0.0.0 --port 1313 --poll 1s
    ports:
      - "1313:1313"
    volumes:
      - .:/site
    profiles: ["dev"]
    labels:
      - "com.ngsanogo.service=dev"

  build:
    container_name: build
    build:
      context: .
      target: hugo
    command: hugo --minify
    volumes:
      - .:/site
    profiles: ["build"]
    labels:
      - "com.ngsanogo.service=build"

  test:
    container_name: test
    build:
      context: .
      target: hugo
    command: sh -c "hugo --minify && test -f public/index.html && test -f public/sitemap.xml && echo 'All checks passed'"
    volumes:
      - .:/site
    profiles: ["test"]
    labels:
      - "com.ngsanogo.service=test"

  lint:
    container_name: lint
    build:
      context: .
      target: lint
    command: pre-commit run --all-files
    volumes:
      - .:/site
      - precommit-cache:/root/.cache/pre-commit
    profiles: ["lint"]
    labels:
      - "com.ngsanogo.service=lint"

  prod:
    container_name: prod
    build:
      context: .
      target: prod
    ports:
      - "8080:8080"
    profiles: ["prod"]
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://127.0.0.1:8080/",
        ]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    labels:
      - "com.ngsanogo.service=prod"

volumes:
  precommit-cache:
